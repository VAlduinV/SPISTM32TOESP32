# üìÑ SPISTM32TOESP32 (STM32 + HAL)

–¶–µ–π —Ñ–∞–π–ª —î –æ—Å–Ω–æ–≤–Ω–æ—é —Ç–æ—á–∫–æ—é –≤—Ö–æ–¥—É –¥–ª—è –ø—Ä–æ—à–∏–≤–∫–∏ STM32, —è–∫–∞ —Ä–µ–∞–ª—ñ–∑—É—î –ø—Ä–æ—Å—Ç–∏–π –æ–±–º—ñ–Ω –ø–æ SPI –≤ —Ä–µ–∂–∏–º—ñ **slave** —Ç–∞ –∫–µ—Ä—É–≤–∞–Ω–Ω—è —Å–≤—ñ—Ç–ª–æ–¥—ñ–æ–¥–æ–º –Ω–∞ –≤–∏–≤–æ–¥—ñ `PC13`.

![SPI schema](IMAGE/SPI_ESP32_STM32.jpg)

---

## üîß –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è

### `HAL_Init()`
- –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î HAL-–±—ñ–±–ª—ñ–æ—Ç–µ–∫—É —Ç–∞ –±–∞–∑–æ–≤—ñ —Å–∏—Å—Ç–µ–º–Ω—ñ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏.

### `SystemClock_Config()`
- –ù–∞–ª–∞—à—Ç–æ–≤—É—î —Ç–∞–∫—Ç—É–≤–∞–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏:
  - –î–∂–µ—Ä–µ–ª–æ: **HSI (–≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä)**.
  - –ë–µ–∑ PLL.
  - –¢–∞–∫—Ç–æ–≤–∞ —á–∞—Å—Ç–æ—Ç–∞ –¥–ª—è —à–∏–Ω AHB, APB1, APB2 ‚Äî –±–µ–∑ –ø–æ–¥—ñ–ª—É (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ —à–≤–∏–¥–∫—ñ—Å—Ç—å).

---

## ‚öôÔ∏è –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–µ—Ä–∏—Ñ–µ—Ä—ñ—ó

### `MX_GPIO_Init()`
- –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î GPIO:
  - `PC13` –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ —è–∫ **–≤–∏–≤—ñ–¥** (`Output Push-Pull`) –±–µ–∑ –ø—ñ–¥—Ç—è–≥—É–≤–∞–Ω–Ω—è.
  - –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤ **–Ω–∏–∑—å–∫–∏–π —Ä—ñ–≤–µ–Ω—å** (–≤–∫–ª—é—á–µ–Ω–Ω—è LED).

### `MX_SPI1_Init()`
- –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è SPI1 —è–∫ **Slave**:
  - –î–≤–æ—Å—Ç–æ—Ä–æ–Ω–Ω—ñ–π —Ä–µ–∂–∏–º (2 –ª—ñ–Ω—ñ—ó).
  - 8-–±—ñ—Ç–Ω–∞ –ø–µ—Ä–µ–¥–∞—á–∞.
  - –ü–æ–ª—è—Ä–Ω—ñ—Å—Ç—å —Ç–∞–∫—Ç–æ–≤–æ–≥–æ —Å–∏–≥–Ω–∞–ª—É: –Ω–∏–∑—å–∫–∞ (`CPOL = 0`).
  - –§–∞–∑–∞: –ø–µ—Ä—à–∏–π —Ñ—Ä–æ–Ω—Ç (`CPHA = 0`).
  - NSS: –∞–ø–∞—Ä–∞—Ç–Ω–∏–π –≤—Ö—ñ–¥.
  - –ü–æ—Ä—è–¥–æ–∫ –±—ñ—Ç—ñ–≤: MSB –ø–µ—Ä—à–∏–º.
  - CRC: –≤–∏–º–∫–Ω–µ–Ω–æ.

---

## üì¶ –ë—É—Ñ–µ—Ä–∏

```c
uint8_t rx_buffer[1];         // –ë—É—Ñ–µ—Ä –¥–ª—è –ø—Ä–∏–π–Ω—è—Ç–∏—Ö –¥–∞–Ω–∏—Ö –ø–æ SPI
uint8_t tx_buffer[1] = {0xAB}; // –î–∞–Ω—ñ, —è–∫—ñ –ø–æ—Å—Ç—ñ–π–Ω–æ –ø–µ—Ä–µ–¥–∞—é—Ç—å—Å—è –Ω–∞–∑–∞–¥
```

## üîÅ –û—Å–Ω–æ–≤–Ω–∏–π —Ü–∏–∫–ª (while(1))

–£ –Ω–µ—Å–∫—ñ–Ω—á–µ–Ω–Ω–æ–º—É —Ü–∏–∫–ª—ñ:
    
1. –û–±–º—ñ–Ω –ø–æ SPI:

```c
HAL_SPI_TransmitReceive(&hspi1, tx_buffer, rx_buffer, 1, HAL_MAX_DELAY);
```

- –í—ñ–¥–ø—Ä–∞–≤–ª—è—î—Ç—å—Å—è –±–∞–π—Ç 0xAB.

- –ü—Ä–∏–π–º–∞—î—Ç—å—Å—è –±–∞–π—Ç —É rx_buffer.

2. –ú–∏–≥–æ—Ç—ñ–Ω–Ω—è LED –Ω–∞ PC13:

```c
HAL_GPIO_WritePin(GPIOC, GPIO_PIN_13, GPIO_PIN_RESET); // –í–∫–ª—é—á–µ–Ω–Ω—è LED
HAL_Delay(100);                                         // –ó–∞—Ç—Ä–∏–º–∫–∞ 100 –º—Å
HAL_GPIO_WritePin(GPIOC, GPIO_PIN_13, GPIO_PIN_SET);   // –í–∏–º–∫–Ω–µ–Ω–Ω—è LED
```

LED –±–ª–∏–º–∞—Ç–∏–º–µ –∫–æ–∂–µ–Ω SPI-–æ–±–º—ñ–Ω –∑ –∑–∞—Ç—Ä–∏–º–∫–æ—é 100 –º—Å.

## üõ† –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫

```c
Error_Handler()
```

–í —Ä–∞–∑—ñ –ø–æ–º–∏–ª–∫–∏:

- –í–∏–º–∏–∫–∞—é—Ç—å—Å—è –ø–µ—Ä–µ—Ä–∏–≤–∞–Ω–Ω—è (__disable_irq()).

- MCU –∑–∞—Ü–∏–∫–ª—é—î—Ç—å—Å—è —É –Ω–µ—Å–∫—ñ–Ω—á–µ–Ω–Ω–æ–º—É —Ü–∏–∫–ª—ñ.

## üß™ –ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω—ñ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è

–û–±—Ä–æ–±–∫–∞ –¥–∞–Ω–∏—Ö —É rx_buffer, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥:

- –ö–æ–º–∞–Ω–¥–∏ –≤—ñ–¥ –º–∞—Å—Ç–µ—Ä–∞ –ø–æ SPI.

- –£–≤—ñ–º–∫–Ω–µ–Ω–Ω—è/–≤–∏–º–∫–Ω–µ–Ω–Ω—è LED.

- –ü–µ—Ä–µ—Ö—ñ–¥ –Ω–∞ –ø–µ—Ä–µ—Ä–∏–≤–∞–Ω–Ω—è SPI –¥–ª—è –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó.

- –í–∏–≤–µ–¥–µ–Ω–Ω—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —á–µ—Ä–µ–∑ UART (–≤—ñ–¥–ª–∞–¥–∫–∞).

## üñ• –¢–∏–ø–æ–≤–µ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è

- –ü–ª–∞—Ç–∞ STM32 (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, Nucleo-F103, F401 —Ç–æ—â–æ)

- SPI-–º–∞—Å—Ç–µ—Ä (—ñ–Ω—à–∞ MCU, Raspberry Pi, Arduino)

- –°–≤—ñ—Ç–ª–æ–¥—ñ–æ–¥ –ø—ñ–¥–∫–ª—é—á–µ–Ω–∏–π –¥–æ PC13 (–≤–±—É–¥–æ–≤–∞–Ω–∏–π –Ω–∞ Nucleo)

## ‚úÖ –ü—ñ–¥—Å—É–º–æ–∫

–¶–µ–π –∫–æ–¥:

- –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î SPI1 —è–∫ Slave.

- –ü–µ—Ä–µ–¥–∞—î –ø–æ SPI –±–∞–π—Ç 0xAB —ñ –∑—á–∏—Ç—É—î 1 –±–∞–π—Ç –≤—ñ–¥ SPI-–º–∞—Å—Ç–µ—Ä–∞.

- –ú–∏–≥–æ—Ç–∏—Ç—å LED –ø—Ä–∏ –∫–æ–∂–Ω–æ–º—É –æ–±–º—ñ–Ω—ñ.

- –ü—Ä–æ—Å—Ç–∏–π –ø—Ä–∏–∫–ª–∞–¥ –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è SPI-–∑–≤'—è–∑–∫—É –º—ñ–∂ MCU –≤ —Ä–µ–∂–∏–º—ñ Slave.